<div id='join-game' class='hidden padded'>
  <h1 class='text-center'>Poison the Well</h1>
  {{#if game_has_started}}
    <h2 class='text-center'>The game has already started!</h2>
    {{#if errors}}
      <p class='errors'>{{errors}}</p>
    {{/if}}
    <a class='spectate' href='/game'>Spectate Game</a>
  {{else}}
    <h2 class='text-center'>Welcome new player! There are currently {{player_count}} other players waiting.<br>Enter your name and join:</h2>

    {{#if errors}}
      <p class='errors'>{{errors}}</p>
    {{/if}}
    <form method="POST" id='new-player-form' action="/player" class="form">
      <label>Name:</label>
      <input type="text" id="name" name="name" value="" />
      <div><label>Role:</label></div><br>
        {{~#each characters~}}
          <div class="player__waiting text-center wide4 spacer-bottom {{#if this.is_selected}}disabled{{/if}}">
            <div class='player__sprite'>
              <img src='images/characters/{{this.name}}.png'>
            </div>
            <div class='player__role'>
              {{this.name}}
            </div>
            <input type="radio" name="character_id" value="{{this.uniq_id}}" {{#if this.is_selected}}disabled{{/if}}>
          </div>        
        {{~/each~}}
      <div>
        <label>Resource Name:</label>
        <input type="text" id="resource-name" name="resource-name" value="" />
      </div>
      <div class='resource-creation'>
        <label>Resource:</label><br>
        <canvas id="playerResource" width="210" height="210"></canvas>
        <canvas id="playerResourceActual" width="21" height="21"></canvas>

        <label for="color-input" id="color-label" style="background-color: red"></label>
        <input type="checkbox" id="color-input" checked></input>

        <div id="color-picker">
          <canvas id="color-block" height="150" width="150"></canvas>
          <canvas id="color-strip" height="150" width="30"></canvas>
        </div>
      </div>
      <input type="text" id="resource-data" name="resource-data" value="" style="display:none;"/>
      <div class='save-button'>Join</div>
    </form>
  {{/if}}
</div>

<div id='reconnect-to-game' class='hidden text-center'>
  <h2>Welcome back <span class='_player-name'></span></h2>
  <a href='/players'>Rejoin Game</a>
</div>

<script>
var socket = io.connect("{{root_url}}");
var player_id = localStorage.getItem("playerID");
localStorage.removeItem("intro_seen");

socket.on('connect', function(data) {
  socket.emit('join', player_id);
});

socket.on('not-found', function() {
  var menu = document.getElementById("join-game");
  menu.style.display = "block";
  localStorage.removeItem("playerID");
});

socket.on('reconnect', function() {
  var menu = document.getElementById("reconnect-to-game");
  menu.style.display = "block";
  $('.spectate').hide();
});

$('.save-button').click(function() {
  $('#resource-data').val($('#playerResourceActual')[0].toDataURL());
  $('#new-player-form').submit();
});


// Resource Drawing
var pixel_size = 10;
var canvas = document.getElementById('playerResource');
var context = canvas.getContext('2d');
var actual_context = document.getElementById('playerResourceActual').getContext('2d');
context.fillStyle = 'rgba(255,0,0,1)';
context.strokeStyle = 'rgba(220,220,220,1)';
actual_context.fillStyle = 'rgba(255,0,0,1)';
actual_context.strokeStyle = 'rgba(220,220,220,1)';
context.lineWidth = 1;
for (var i=0; i<21; ++i) {
  var pix = i * pixel_size;
  context.beginPath();
  context.moveTo(0, pix);
  context.lineTo(21*pixel_size, pix);
  context.stroke();
  context.beginPath();
  context.moveTo(pix, 0);
  context.lineTo(pix, 21*pixel_size);
  context.stroke();
}
// context.fillRect(10,10,1,1);

var draw = false;
var drawX = 0;
var drawY = 0;
function drawdown(e) {
  draw = true;
  var pos = getCursorPosition(e);
  // testval = e;
  // context.fillRect( pos.x, pos.y, 1);

  drawX = pos.x;
  drawY = pos.y;
  // context.beginPath();
  // context.arc(pos.x-1, pos.y-1, 2, 0, 2 * Math.PI, false);
  // context.fill();
  // context.closePath();
  drawPixelAt(pos.x, pos.y);
}

function drawmove(e) {
  if (draw) {
    var pos = getCursorPosition(e);
    drawX = pos.x;
    drawY = pos.y;
    drawPixelAt(pos.x, pos.y);
  }
}

function drawPixelAt(x,y) {
  var root_x = Math.floor(x / pixel_size);
  var root_y = Math.floor(y / pixel_size);
  actual_context.fillRect(root_x,root_y,1,1);
  root_x *= pixel_size;
  root_y *= pixel_size;
  context.fillRect(root_x,root_y,pixel_size,pixel_size);
}

function drawup(e) {
  draw = false;
}

function getCursorPosition(event) {
  var rect = canvas.getBoundingClientRect();
  var x = event.clientX - rect.left;
  var y = event.clientY - rect.top;
  return {x:Math.round(x), y:Math.round(y)}
}

canvas.addEventListener("mousedown", drawdown, false);
canvas.addEventListener("mouseup", drawup, false);
canvas.addEventListener("mousemove", drawmove, false);

// canvas.addEventListener("touchstart", function (e) {
//         mousePos = getTouchPos(canvas, e);
//   var touch = e.touches[0];
//   var mouseEvent = new MouseEvent("mousedown", {
//     clientX: touch.clientX,
//     clientY: touch.clientY
//   });
//   canvas.dispatchEvent(mouseEvent);
// }, false);
// canvas.addEventListener("touchend", function (e) {
//   var mouseEvent = new MouseEvent("mouseup", {});
//   canvas.dispatchEvent(mouseEvent);
// }, false);
// canvas.addEventListener("touchmove", function (e) {
//   var touch = e.touches[0];
//   var mouseEvent = new MouseEvent("mousemove", {
//     clientX: touch.clientX,
//     clientY: touch.clientY
//   });
//   canvas.dispatchEvent(mouseEvent);
// }, false);

// canvas.addEventListener("touchstart", drawdown, false);
// canvas.addEventListener("touchend", drawup, false);
// canvas.addEventListener("touchmove", drawmove, false);



// Color picker JS
var colorBlock = document.getElementById('color-block');
var ctx1 = colorBlock.getContext('2d');
var width1 = colorBlock.width;
var height1 = colorBlock.height;

var colorStrip = document.getElementById('color-strip');
var ctx2 = colorStrip.getContext('2d');
var width2 = colorStrip.width;
var height2 = colorStrip.height;

var colorLabel = document.getElementById('color-label');

var x = 0;
var y = 0;
var drag = false;
var rgbaColor = 'rgba(255,0,0,1)';

ctx1.rect(0, 0, width1, height1);
fillGradient();

ctx2.rect(0, 0, width2, height2);
var grd1 = ctx2.createLinearGradient(0, 0, 0, height1);
grd1.addColorStop(0, 'rgba(255, 0, 0, 1)');
grd1.addColorStop(0.17, 'rgba(255, 255, 0, 1)');
grd1.addColorStop(0.34, 'rgba(0, 255, 0, 1)');
grd1.addColorStop(0.51, 'rgba(0, 255, 255, 1)');
grd1.addColorStop(0.68, 'rgba(0, 0, 255, 1)');
grd1.addColorStop(0.85, 'rgba(255, 0, 255, 1)');
grd1.addColorStop(1, 'rgba(255, 0, 0, 1)');
ctx2.fillStyle = grd1;
ctx2.fill();

function click(e) {
  x = e.offsetX;
  y = e.offsetY;
  var imageData = ctx2.getImageData(x, y, 1, 1).data;
  rgbaColor = 'rgba(' + imageData[0] + ',' + imageData[1] + ',' + imageData[2] + ',1)';
  fillGradient();
}

function fillGradient() {
  ctx1.fillStyle = rgbaColor;
  ctx1.fillRect(0, 0, width1, height1);

  var grdWhite = ctx2.createLinearGradient(0, 0, width1, 0);
  grdWhite.addColorStop(0, 'rgba(255,255,255,1)');
  grdWhite.addColorStop(1, 'rgba(255,255,255,0)');
  ctx1.fillStyle = grdWhite;
  ctx1.fillRect(0, 0, width1, height1);

  var grdBlack = ctx2.createLinearGradient(0, 0, 0, height1);
  grdBlack.addColorStop(0, 'rgba(0,0,0,0)');
  grdBlack.addColorStop(1, 'rgba(0,0,0,1)');
  ctx1.fillStyle = grdBlack;
  ctx1.fillRect(0, 0, width1, height1);
}

function mousedown(e) {
  drag = true;
  changeColor(e);
}

function mousemove(e) {
  if (drag) {
    changeColor(e);
  }
}

function mouseup(e) {
  drag = false;
}

function changeColor(e) {
  x = e.offsetX;
  y = e.offsetY;
  var imageData = ctx1.getImageData(x, y, 1, 1).data;
  
  rgbaColor = 'rgba(' + imageData[0] + ',' + imageData[1] + ',' + imageData[2] + ',1)';
  context.fillStyle = rgbaColor;
  context.strokeStyle = rgbaColor;
  actual_context.fillStyle = rgbaColor;
  actual_context.strokeStyle = rgbaColor;
  colorLabel.style.backgroundColor = rgbaColor;
}

colorStrip.addEventListener("click", click, false);

colorBlock.addEventListener("mousedown", mousedown, false);
colorBlock.addEventListener("mouseup", mouseup, false);
colorBlock.addEventListener("mousemove", mousemove, false);

</script>
