<div class="game">
  <div class="gameboard">
    <img src='images/gameboard/courtyard.png' class="board">
    {{> player_market_stand box_classes='horizontal-box box-1'}}
    {{> player_market_stand box_classes='horizontal-box box-5'}}
    {{> player_market_stand box_classes='vertical-box box-2'}}
    {{> player_market_stand box_classes='vertical-box box-6'}}
    {{> player_market_stand box_classes='horizontal-box box-3'}}
    {{> player_market_stand box_classes='horizontal-box box-7'}}
    {{> player_market_stand box_classes='vertical-box vertical-left box-4'}}
    {{> player_market_stand box_classes='vertical-box vertical-left box-8'}}

    <div class='trade-spot spot-1' data-spot-id='1'></div>
    <div class='trade-spot spot-2' data-spot-id='2'></div>
    <div class='trade-spot spot-3' data-spot-id='3'></div>
    <div class='trade-spot spot-4' data-spot-id='4'></div>
    <div class='trade-spot spot-5' data-spot-id='5'></div>
    <div class='trade-spot spot-6' data-spot-id='6'></div>
    <div class='trade-spot spot-7' data-spot-id='7'></div>
    <div class='trade-spot spot-8' data-spot-id='8'></div>
  </div>
  <div class="sidebar">
    <img src='images/gameboard/sidebar.png' class="layout">
    <div class="section header-info">
      <div class='player-name'></div>
      <div class='player-image'></div>
      <div class="food-requirement">
        <div class='label'>Food:</div>
        <div class='resource-list'>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
        </div>
      </div>
      <div class="victory-point-requirement">
        <div class='label'>Victory Point:</div>
        <div class='resource-list'>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
        </div>
      </div>
    </div>
    <div class="section worker-info">
      <div class='title'></div>
      <div class='strikes'>
        <div class='dead'></div>
        <div class='dead'></div>
        <div class='dead'></div>
        <div class='dead'></div>
      </div>
      <div class="worker-list">
         <div class='worker'>
          <select id='worker1'>
            {{~#each game.resources~}}
              <option value="{{this}}">{{this}}</option>
            {{~/each~}}
          </select>
        </div>
         <div class='worker'>
          <select id='worker2'>
            {{~#each game.resources~}}
              <option value="{{this}}">{{this}}</option>
            {{~/each~}}
          </select>
        </div>
         <div class='worker'>
          <select id='worker3'>
            {{~#each game.resources~}}
              <option value="{{this}}">{{this}}</option>
            {{~/each~}}
          </select>
        </div>
         <div class='worker'>
          <select id='worker4'>
            {{~#each game.resources~}}
              <option value="{{this}}">{{this}}</option>
            {{~/each~}}
          </select>
        </div>
      </div>
      <button class='abs worker-done'>Done</button>
    </div>
    <div class="section home-inventory">
      <div class='title'>Resources:</div>
      <div class='resource-long-list'>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
      </div>
    </div>
    <div class="section market-inventory">
      <div class='title'>Resources at market:</div>
      <div class='resource-list'>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
      </div>
    </div>
    <div class="section tradebox">
      <div class='title'>Trading:</div>
      <div class="my-trade">
        <div class='resource-list'>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
        </div>
      </div>

      <div class="their-trade">
        <div class="player-image"></div>
        <div class="player-name"></div>
        <div class='resource-list'>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
var socket = io.connect("{{root_url}}");
var player_id = localStorage.getItem("playerID");
var needs_initialization = true;

socket.on('connect', function(data) {
  socket.emit('get-match-data', player_id);
});

var review;
socket.on('match-data', function(data) {
  review = data;

  // DEBUG
  player_id = data.game.players[3].uniq_id;

  players = data.game.players;

  for (var i=0; i < players.length; i++) {
    set_players(i+1, players[i]);
    if (players[i].uniq_id == player_id) {
      if (needs_initialization) {
        init_sidebar(players[i]);
      }
      update_sidebar(players[i]);
    }
  }
});

$('.worker-done').click(function() {
  var farming = [
    $('#worker1 option:selected').val(),
    $('#worker2 option:selected').val(),
    $('#worker3 option:selected').val(),
    $('#worker4 option:selected').val()
  ];
  socket.emit('player-ready', player_id, {"farming": farming});
});

function set_players(pos, player) {
  var base_box = $('.box-'+pos);
  base_box.find('.player .player-name').html(player.name);
  base_box.find('.player .player-image').html(player.image);
  base_box.find('.player .player-image-marker').html(player.image);

  base_box.find('.trade-inventory .resource img').remove();
  inventory = player.market_inventory;
  for (var i = 0; i < inventory.length; i++ ) {
    base_box.find('.trade-inventory .resource').eq(i).html(inventory[i].image);
  }
}

function init_sidebar(player) {
  $('.sidebar .header-info .player-name').html(player.name);
  $('.sidebar .header-info .player-image').html(player.image);
  $('.sidebar .worker-info .title').html(player.character.name+"s:");
  $(".sidebar .worker-info .worker option[value='"+player.character.resource+"']").html(player.character.resource+" x2");
  needs_initialization = false;
}

function update_sidebar(player) {
  // Set goals
  food_goal = player.food_goal
  for (var i = 0; i < food_goal.length; i++ ) {
    var img = resource_image(food_goal[i]);
    $('.sidebar .header-info .food-requirement .resource').eq(i).html(img);
  }
  victory_goal = player.victory_goal
  for (var i = 0; i < victory_goal.length; i++ ) {
    var img = resource_image(victory_goal[i]);
    $('.sidebar .header-info .victory-point-requirement .resource').eq(i).html(img);
  }

  // Set worker lives
  times_poisoned = 3 - player.extra_lives;
  for (var i = 0; i < times_poisoned; i++ ) {
    $('.sidebar .worker-info .dead').eq(i).html(resource_image('hit'));
    $('.sidebar .worker-list select').eq(3-i).prop('disabled', 'disabled');
  }

  // Set home inventory
  home_inventory = player.home_inventory
  for (var i = 0; i < home_inventory.length; i++ ) {
    $('.sidebar .home-inventory .resource').eq(i).html(home_inventory[i].image);
  }
  // Set market inventory
  market_inventory = player.market_inventory
  for (var i = 0; i < market_inventory.length; i++ ) {
    $('.sidebar .market-inventory .resource').eq(i).html(market_inventory[i].image);
  }

  // Set trade inventory

}

function resource_image(resource) {
  return "<img src='images/resources/"+resource+".png'>"
}

</script>

