<div class="game">
  <div class='scroll-winner'></div>
  <div class="text-scroll">
    <img src='images/gameboard/text_scroll.png'>
    <div class='scroll-message'>
      <p class='text-header'>The King is at war!</p>
      <p class='text-body'>
        And he needs our help. It is our duty, as a group, to produce and send <b> {{vp_needed}} </b> 
        shipments of resources to win the war and bring our army home. But we should hurry.
        Rumor has it a <i>necromancer</i> is amongst us and plots to kill us all.
        <br><br>
        Careful who you trade with and try to bring our king home!
      </p>
    </div>
    <button class='scroll-accept'>OK</button>
  </div>
  <div class="gameboard">
    <img src='images/gameboard/courtyard.png' class="board">
    {{> player_market_stand box_classes='horizontal-box box-1'}}
    {{> player_market_stand box_classes='horizontal-box box-5'}}
    {{> player_market_stand box_classes='vertical-box box-2'}}
    {{> player_market_stand box_classes='vertical-box box-6'}}
    {{> player_market_stand box_classes='horizontal-box box-3'}}
    {{> player_market_stand box_classes='horizontal-box box-7'}}
    {{> player_market_stand box_classes='vertical-box vertical-left box-4'}}
    {{> player_market_stand box_classes='vertical-box vertical-left box-8'}}

    <div class='trading-spots'>
      <div class='trade-spot' data-spot-id='0'></div>
      <div class='trade-spot' data-spot-id='1'></div>
      <div class='trade-spot' data-spot-id='2'></div>
      <div class='trade-spot' data-spot-id='3'></div>
      <div class='trade-spot' data-spot-id='4'></div>
      <div class='trade-spot' data-spot-id='5'></div>
      <div class='trade-spot' data-spot-id='6'></div>
      <div class='trade-spot' data-spot-id='7'></div>
    </div>
    <img src='images/misc/cat-thryn.png' class="layout cat">
  </div>
  <div class="sidebar">

    <div class='game-state'>
      <span class='time'>Morning</span> of Day <span class='day'>1</span>
    </div>
    <div class="section section0 header-info">
      <div class='player-name'></div>
      <div class='player-image'></div>
      <div class="food-requirement purchase-option">
        <div class='label'>Food:</div>
        <div class='resource-list'>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource extra-food'></div>
          <div class='resource extra-food'></div>
        </div>
      </div>
      <div class="victory-point-requirement purchase-option">
        <div class='label'>Victory Point:</div>
        <div class='resource-list'>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
        </div>
      </div>
      <div class="poison-requirement purchase-option">
        <div class='label'>Poison:</div>
        <div class='resource-list'>
          <div class='resource'></div>
          <div class='resource'></div>
        </div>
      </div>
      <div class="zombie-requirement purchase-option">
        <div class='label'>Zombie:</div>
        <div class='resource-list'>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
        </div>
      </div>
    </div>
    <div class="section section1 worker-info">
      <div class='title'></div>
      <div class='strikes'>
        <div class='dead'></div>
        <div class='dead'></div>
        <div class='dead'></div>
        <div class='dead'></div>
      </div>
      <div class="worker-list">
         <div class='worker'>
          <select id='worker1'>
            {{~#each game.resources~}}
              <option value="{{this}}">{{this}}</option>
            {{~/each~}}
          </select>
        </div>
         <div class='worker'>
          <select id='worker2'>
            {{~#each game.resources~}}
              <option value="{{this}}">{{this}}</option>
            {{~/each~}}
          </select>
        </div>
         <div class='worker'>
          <select id='worker3'>
            {{~#each game.resources~}}
              <option value="{{this}}">{{this}}</option>
            {{~/each~}}
          </select>
        </div>
         <div class='worker'>
          <select id='worker4'>
            {{~#each game.resources~}}
              <option value="{{this}}">{{this}}</option>
            {{~/each~}}
          </select>
        </div>
      </div>
      <!-- <button class='abs all-worker-done' style="bottom: 5px;">EVERYONE IS Done</button> -->
      <button class='abs worker-done'>Done</button>
      <div class='abs worker-done-pushed'>Ready</div>

    </div>
    <div class="section section2 home-inventory">
      <div class='title'>Resources:</div>
      <div class='resource-long-list'>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
      </div>
    </div>
    <div class="section section3 market-inventory">
      <div class='title'>Resources at market:</div>
      <div class='resource-list'>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
        <div class='resource'></div>
      </div>
    </div>
    <div class="section section4 tradebox">
      <div class='title'>Trading:</div>
      <div class="my-trade">
        <div class='resource-list'>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
        </div>
      </div>
      <div class='trade-agreement'>
        <div class='my-status'>Not Ready</div>
        <button class='abs trade-ready'>Ready</button>
        <button class='abs trade-cancel'>Cancel</button>
        <div class='their-status'>Not Ready</div>
      </div>

      <div class="their-trade">
        <div class="player-image"></div>
        <div class="player-name"></div>
        <div class='resource-list'>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
          <div class='resource'></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">

var socket = io.connect("{{root_url}}");
var player_id = localStorage.getItem("playerID");
var needs_initialization = true;

var review;
var game_phases = ['Morning','Noon','Afternoon','Evening'];
var current_game_phase = 0;

var intro_seen = localStorage.getItem("intro_seen");
var message_data = [];

if (player_id == null || player_id == '') {
  $(".section").hide();
}

socket.on('connect', function(data) {
  socket.emit('get-match-data', player_id);
});

socket.on('match-data', function(data) {
  review = data;

  if (data.messages != null) {
    message_data = message_data.concat(data.messages);
    show_scroll();
  }

  // DEBUG
  // if (needs_initialization) {
  //   player_id = data.game.players[Math.floor(Math.random() * data.game.players.length)].uniq_id;
  // }

  current_game_phase = data.game.phase;
  var current_day = data.game.day;
  set_game_phase(current_game_phase, current_day);

  players = data.game.players;

  $('.gameboard .trading-spots .trade-spot').html('');

  var this_player = null;
  for (var i=0; i < players.length; i++) {
    set_players(i+1, players[i]);
    if (players[i].uniq_id == player_id) {
      this_player = players[i];
    }
  }

  // Update current player specifics:
  if (this_player != null) {
    if (needs_initialization) {
      init_sidebar(this_player, i+1);
    }
    update_sidebar(this_player);
    update_sidebar_trade(this_player, data.game.trading_post)
    save_local_goals(this_player);
    if (this_player.is_necromancer) {
      showPoisonedResources();
    }
  }
});

$('.worker-done').click(function() {
  var farming = [
    $('#worker1 option:selected').val(),
    $('#worker2 option:selected').val(),
    $('#worker3 option:selected').val(),
    $('#worker4 option:selected').val()
  ];
  socket.emit('player-ready', player_id, {"farming": farming});
});

// DEBUG
$('.all-worker-done').click(function() {
  socket.emit('player-ready', player_id, {next_phase: true});
});

$('.trade-cancel').click(function() {
  cancel_trade();
})

var trade_value = false;
$('.trade-ready').click(function() {
  update_trade_state(!trade_value);
});

var selected_poison = null;

var testest = null;
$('.home-inventory .resource, .market-inventory .resource, .my-trade .resource').click(function(obj) {
  testest = obj;
  resource_element = $(obj.currentTarget).find('img')

  // If poison is selected
  if (resource_element[0].className.includes("Poison")) {
    $('.Poison').parent().removeClass('poisoned');
    if (selected_poison == resource_element.data('resource-id')) {
      selected_poison = null;
    } else {
      selected_poison = resource_element.data('resource-id');
      resource_element.parent().addClass("poisoned");  
    }
    
    removePurchaseProgress();
    return null;
  } else if (selected_poison != null) {
    var resource_id = resource_element.data('resource-id');
    if (resource_id) {
      socket.emit('resource-poisoned', player_id, {"resource_id": resource_id, "poison_id": selected_poison});
    }
    $('.Poison').parent().removeClass('poisoned');
    selected_poison = null;
    removePurchaseProgress();
    return null;
  }

  // If in payment phase
  if (current_game_phase == 3) {
    var resource_type = resource_element.data('resource-type');
    var attempted_resource_id = resource_element.data('resource-id');

    // Verify this resource hasnt already been selected to be used as payment
    if (!local_resource_ids.includes(attempted_resource_id)) {
      local_resource_ids[local_resource_ids.length] = attempted_resource_id
      local_payment[local_payment.length] = resource_type;
      compare_local_payment();
    }
    
  // else moving between inventories
  } else {
    if (resource_element) {
      var resource_id = resource_element.data('resource-id');
      if (resource_id) {
        socket.emit('resource-selected', player_id, {"resource_id": resource_id});
      }
    }
  }
})

$('.trade-spot').click(function(obj) {
  testest = obj;
  spot_id = $(obj.currentTarget).data('spot-id');
  if (spot_id != null) {
    socket.emit('trade-spot-selected', player_id, {"trade_spot_id": spot_id});
  }
});



$(".scroll-accept").click(function() {
  hide_scroll();
});

var game_has_ended = false;

function hide_scroll() {
  localStorage.setItem("intro_seen", true);
  if (message_data.length == 0) {
    $(".text-scroll").hide();
    if (game_has_ended) {
      clearCacheAndGoHome();
    }
  } else {
    show_scroll();
  }
}

function show_scroll() {
  next_message = message_data.shift();
  if (next_message) {
    if (next_message.victory) {
      if (next_message.victory == "necromancer") {
        $(".scroll-winner").html("<img src='images/gameboard/necromancer.png'>");
      } else {
        $(".scroll-winner").html("<img src='images/gameboard/king.png'>");
      }
      game_has_ended = true;
      $(".scroll-winner").show();
    } 
    $(".text-scroll .text-header").html(next_message.title);
    $(".text-scroll .text-body").html(next_message.body);
    $(".text-scroll").show();
  }
}

function clearCacheAndGoHome() {
  $(".scroll-winner").hide();
  localStorage.removeItem("playerID");
  window.location.replace("/");
}

if (intro_seen) {
  hide_scroll();
}

$('.cat').click(function() {
  alert("Cat-thryn says 'Meow!'");
})

function cancel_trade() {
  socket.emit('trade-cancelled', player_id);
}

function update_trade_state(value) {
  socket.emit('trade-ready', player_id, {'trade_ready': value});
}

function set_players(pos, player) {
  var base_box = $('.box-'+pos);

  if (needs_initialization) {
    base_box.find('.player .player-name').html(player.name);
    base_box.find('.player .player-image-marker').html(player.image);
    base_box.find('.player .player-image-marker').data("player-id", player.uniq_id);
  }

  if(player.is_ready) {
    base_box.find('.player .player-ready-marker').show();
  } else {
    base_box.find('.player .player-ready-marker').hide();
  }

  base_box.find('.player .player-image').html('');
  base_box.find('.trade-inventory .resource img').remove();

  var lives_left = (3 - player.extra_lives);
  base_box.find('.player .player-hit-counter').html(" X ".repeat(lives_left));
  // for (var i=0; i < lives_left; ++i) {
  //   hit_string = hit_string + " X"
  // }

  if (is_player_visible_at_market(player)) {

    if (player.trade_post_id == null) {
      base_box.find('.player .player-image').html(player.image);
    } else {
      $('.gameboard .trading-spots .trade-spot').eq(player.trade_post_id).html(player.image);
    }

    
    inventory = player.market_inventory;
    for (var i = 0; i < inventory.length; i++ ) {
      if (inventory[i] != null) {
        base_box.find('.trade-inventory .resource').eq(i).html(inventory[i].image);
      } else {
        base_box.find('.trade-inventory .resource').eq(i).html('');
      }
    }
  }
}

function is_player_visible_at_market(player) {
  if (current_game_phase == 1 && player.is_ready) {
    return true;
  } else if (current_game_phase == 2 && !player.is_ready) {
    return true;
  }
  return false;
}

function init_sidebar(player, pos) {
  $('.sidebar .header-info .player-name').html(player.name);
  if (player.is_necromancer) {
    $('.sidebar .header-info .player-name').prepend("<span>Necromancer</span> ");
    $('.sidebar .header-info .victory-point-requirement').hide();
    $('.sidebar .header-info .extra-food').hide();
    $('.sidebar .header-info .poison-requirement').show();
    $('.sidebar .header-info .zombie-requirement').show();
  }
  $('.sidebar .header-info .player-image').html(player.image);
  $('.sidebar .worker-info .title').html(player.character.name+"s:");
  $(".sidebar .worker-info .worker option[value='"+player.character.resource+"']").html(player.character.resource+" x2");
  $('.box-'+pos+' .player .player-image-marker').click(function() {
    cancel_trade();
  });
  needs_initialization = false;
}
var testestest = null;
function update_sidebar(player) {
  // Set goals
  testestest = player;
  food_goal = player.food_goal
  if (food_goal.join() != local_food.join()) {
    $('.sidebar .header-info .food-requirement .resource').empty();
    for (var i = 0; i < food_goal.length; i++ ) {
      var img = resource_image(food_goal[i]);
      $('.sidebar .header-info .food-requirement .resource').eq(i).html(img);
    }
  }
  victory_goal = player.victory_goal
  if (victory_goal.join() != local_victory.join()) {
    $('.sidebar .header-info .victory-point-requirement .resource').empty();
    for (var i = 0; i < victory_goal.length; i++ ) {
      var img = resource_image(victory_goal[i]);
      $('.sidebar .header-info .victory-point-requirement .resource').eq(i).html(img);
    }
  }
  poison_goal = player.poison_goal
  if (poison_goal.join() != local_poison.join()) {
    $('.sidebar .header-info .poison-requirement .resource').empty();
    for (var i = 0; i < poison_goal.length; i++ ) {
      var img = resource_image(poison_goal[i]);
      $('.sidebar .header-info .poison-requirement .resource').eq(i).html(img);
    }
  }
  zombie_goal = player.zombie_goal
  if (zombie_goal.join() != local_zombie.join()) {
    $('.sidebar .header-info .zombie-requirement .resource').empty();
    for (var i = 0; i < zombie_goal.length; i++ ) {
      var img = resource_image(zombie_goal[i]);
      $('.sidebar .header-info .zombie-requirement .resource').eq(i).html(img);
    }
  }

  // Set Ready State
  if (player.is_ready) {
    $('.sidebar .worker-done').hide();
    $('.sidebar .worker-done-pushed').show();
  } else {
    $('.sidebar .worker-done').show();
    $('.sidebar .worker-done-pushed').hide();
  }

  // Set worker lives
  times_poisoned = 3 - player.extra_lives;
  for (var i = 0; i < times_poisoned; i++ ) {
    $('.sidebar .worker-info .dead').eq(i).html(resource_image('hit'));
    $('.sidebar .worker-list select').eq(3-i).prop('disabled', 'disabled');
  }

  // Set home inventory
  home_inventory = player.home_inventory
  for (var i = 0; i < home_inventory.length; i++ ) {
    if (home_inventory[i] != null) {
      $('.sidebar .home-inventory .resource').eq(i).html(home_inventory[i].image);
    } else {
      $('.sidebar .home-inventory .resource').eq(i).html('');
    }
  }
  // Set market inventory
  market_inventory = player.market_inventory
  for (var i = 0; i < market_inventory.length; i++ ) {
    if (market_inventory[i] != null) {
      $('.sidebar .market-inventory .resource').eq(i).html(market_inventory[i].image);
    } else {
      $('.sidebar .market-inventory .resource').eq(i).html('');
    }
  }
}

function update_sidebar_trade(player, traders) {
  // Set trade inventory
  trade_inventory = player.trade_inventory
  $('.sidebar .tradebox .my-trade .resource').html('');
  for (var i = 0; i < trade_inventory.length; i++ ) {
    if (trade_inventory[i] != null) {
      $('.sidebar .tradebox .my-trade .resource').eq(i).html(trade_inventory[i].image);
    }
  }

  // Set traders inventory
  // check if trading
  var post_id = player.trade_post_id
  $('.sidebar .tradebox .their-trade .resource').html('');
  $('.sidebar .tradebox .their-trade .player-name').html('');
  $('.sidebar .tradebox .their-trade .player-image').html('');
  trade_value = player.trade_ready;
  $('.sidebar .tradebox .trade-agreement .my-status').html(trade_value ? "Ready" : "Not Ready");
  $('.sidebar .tradebox .trade-agreement .trade-ready').html(!trade_value ? "Ready" : "Not Ready");
  if (post_id != null) {
    // Get paired post (0-1, 2-3, 4-5, 6-7)
    other_post_id = (post_id % 2 == 0) ? post_id + 1 : post_id - 1
    other_trader = traders[other_post_id]
    if (other_trader != null) {

      $('.sidebar .tradebox .their-trade .player-name').html(other_trader.name + " the " + other_trader.character.name);
      $('.sidebar .tradebox .their-trade .player-image').html(other_trader.image);

      traders_inventory = other_trader.trade_inventory
      $('.sidebar .tradebox .their-trade .resource').html('');
      $('.sidebar .tradebox .trade-agreement .their-status').html(other_trader.trade_ready ? "Ready" : "Not Ready");
      for (var i = 0; i < traders_inventory.length; i++ ) {
        if (traders_inventory[i] != null) {
          $('.sidebar .tradebox .their-trade .resource').eq(i).html(traders_inventory[i].image);
        }
      }
    }
  }
}

function resource_image(resource) {
  return "<img src='images/resources/"+resource.toLowerCase()+".png'>"
}

function showPoisonedResources() {
  $(".resource").removeClass('poisoned');
  $(".resource .is-poisoned").parent().addClass('poisoned');
}


var local_food = [];
var local_victory = [];
var local_poison = [];
var local_zombie = [];

var local_payment = [];
var local_resource_ids = [];
var purchase_lock = false;

function save_local_goals(player) {
  local_food = player.food_goal;
  local_victory = player.victory_goal;
  local_poison = player.poison_goal;
  local_zombie = player.zombie_goal;
  purchase_lock = false;
}

function compare_local_payment() {
  var purchase_status = -1;
  var payment_string = local_payment.join('');
  var payment_length = local_payment.length;

  var food_string = local_food.join('');
  if (food_string.indexOf(payment_string) == 0) {
    purchase_status = 0;
    $(".section.header-info .food-requirement").addClass("active");
    $(".section.header-info .food-requirement .resource:lt("+payment_length+")").addClass("active");
    if (food_string == payment_string) {
      purchase_status = -1;
      purchase_selected_item("food", local_resource_ids);
    }
  } else {
    $(".section.header-info .food-requirement").removeClass("active");
  }

  if (purchase_status != 1) {
    var victory_string = local_victory.join('');
    if (victory_string.indexOf(payment_string) == 0) {
      purchase_status = 0;
      $(".section.header-info .victory-point-requirement").addClass("active");
      $(".section.header-info .victory-point-requirement .resource:lt("+payment_length+")").addClass("active");
      if (victory_string == payment_string) {
        purchase_status = -1;
        purchase_selected_item("victory-point", local_resource_ids);
      }
    } else {
      $(".section.header-info .victory-point-requirement").removeClass("active");
    }
  }

  if (purchase_status != 1) {
    var poison_string = local_poison.join('');
    if (poison_string.indexOf(payment_string) == 0) {
      purchase_status = 0;
      $(".section.header-info .poison-requirement").addClass("active");
      $(".section.header-info .poison-requirement .resource:lt("+payment_length+")").addClass("active");
      if (poison_string == payment_string) {
        purchase_status = -1;
        purchase_selected_item("poison", local_resource_ids);
      }
    } else {
      $(".section.header-info .poison-requirement").removeClass("active");
    }
  }

  if (purchase_status != 1) {
    var zombie_string = local_zombie.join('');
    if (zombie_string.indexOf(payment_string) == 0) {
      purchase_status = 0;
      $(".section.header-info .zombie-requirement").addClass("active");
      $(".section.header-info .zombie-requirement .resource:lt("+payment_length+")").addClass("active");
      if (zombie_string == payment_string) {
        selectZombieTarget();
      }
    } else {
      $(".section.header-info .zombie-requirement").removeClass("active");
    }
  }

  if (purchase_status == -1 || local_payment.length == 0) {
    removePurchaseProgress();
  }
  else {
    for(i=0; i < local_resource_ids.length; ++i) {
      $(".home-inventory .resource .resource-"+local_resource_ids[i]).addClass('selected');
    }
  }
}

function selectZombieTarget() {
  $('.gameboard .player-image-marker img').parent().addClass('active');
  $('.gameboard .player-image-marker.active').click(function(e) {
    zombieTargetSelected(e);
  });
}

function zombieTargetSelected(e) {
  var target_id = $(e.currentTarget).data("player-id");
  clearZombieTargetSelect();
  purchase_selected_item("zombie", local_resource_ids, target_id);
  removePurchaseProgress();
}

function clearZombieTargetSelect() {
  $('.gameboard .player-image-marker').removeClass('active');
  $('.gameboard .player-image-marker').unbind();
}

function removePurchaseProgress() {
  clearZombieTargetSelect();
  local_payment = [];
  local_resource_ids = [];
  $(".section.header-info .purchase-option").removeClass("active");
  $(".section.header-info .purchase-option .resource").removeClass("active");
  $(".section.home-inventory .resource img").removeClass("selected");
}

function purchase_selected_item(item_name, resource_array, target_player_id=null) {
  removePurchaseProgress();
  if (purchase_lock == false) {
    purchase_lock = true;
    socket.emit('player-purchase', player_id, {"item": item_name, resources: resource_array, target_player_id: target_player_id});
  }
}

function set_game_phase(phase, day) {
  // Update the time of day
  $('.sidebar .game-state .time').html(game_phases[phase]);
  $('.sidebar .game-state .day').html(day);

  // Highlight the active sidebar sections
  $(".sidebar .section").removeClass("active");
  $(".sidebar .section0").addClass("active");
  if (phase == 0) {
    $(".sidebar .section1").addClass("active");
  } else if (phase == 1) {
    $(".sidebar .section2").addClass("active");
    $(".sidebar .section3").addClass("active");
  } else if (phase == 2) {
    $(".sidebar .section3").addClass("active");
    $(".sidebar .section4").addClass("active");
  } else if (phase == 3) {
    $(".sidebar .section2").addClass("active");
  } 
}

</script>

